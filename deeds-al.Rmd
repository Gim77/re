# deeds-al.Rmd

Create the output file holding the arms-length deeds. In order to cope with having only 16 GB of RAM on my system, only features needed downstream in the pipeline are retained.

Retain only features of deeds, not features of the parcels. The idea is to
rely on the parcels file exclusive for parcels features.

Drop features that are non informative (always missing or always same value).

Drop deeds that are 100% duplicates of other deeds.

Files read and the deeds files the Laufer directory. This directory contains
the file Steve Laufer used in his experiments.

Record layout for the input is in 1080_Record_layout.csv

```{r}
laufer.dir="../data/raw/from-laufer-2010-05-11"

```

Files written.

```{r}
dir.output="../data/v6/output/"
path.deeds.out <- paste(dir.output,
                         "deeds-al.csv",
                         sep="")
```

## Control the script

Set script control variables.

```{r}
testing <- TRUE
```

Initialize R.

```{r}
options(warn=2)  # turn warnings into errors
set.seed(1)      # random number generator seed
require("compiler")
enableJIT(3)     # 3 ==> maximum JIT level
```

Source files here, now that the JIT level is set

```{r}
source("RemoveNonInformative.R")
```

## Define function to read a deeds file

Read one deeds file with suffix "num" in its file name.

```{r}
ReadDeedsFile <- function(num) {
  # Read the deeds file containing num in its name
  # Args:
  # num: number of input file; in {1, 2, ..., 8}
  #
  # Value: a list
  # $df : data.frame containing selected features for arms-length deeds
  # $num.dropped : number of non-arms-length deeds dropped from $df

  # read the deeds file
  # Note: In file 5, data record 945 has an NA value for APN.FORMATTED
  path <- paste(laufer.dir,
                "/deeds/CAC06037F",
                num,
                ".txt.gz",
                sep="")
  cat("\nreading deeds file", path, "\n")
  # NOTE: Don't convert strings to factors, because the other input
    # files may have different values than this file
  df <- read.table(path,
                   header=TRUE,
                   sep="\t",
                   quote="",
                   comment.char="",
                   stringsAsFactors=FALSE,
                   na.strings="",
                   nrows=ifelse(testing,1000,-1))

  cat("records in", path, nrow(df), "\n")

  # keep the features we want
  # add features to trace back to original source
  r <- data.frame(
    APN.UNFORMATTED=df$APN.UNFORMATTED, 
    APN.FORMATTED=df$APN.FORMATTED,
    SALE.AMOUNT=df$SALE.AMOUNT,
    SALE.DATE=df$SALE.DATE,
    RECORDING.DATE=df$RECORDING.DATE,
    DOCUMENT.TYPE.CODE=df$DOCUMENT.TYPE.CODE,
    TRANSACTION.TYPE.CODE=df$TRANSACTION.TYPE.CODE,
    SALE.CODE=df$SALE.CODE,
    MULTI.APN.FLAG.CODE=df$MULTI.APN.FLAG.CODE,
    MULTI.APN.COUNT=df$MULTI.APN.COUNT,
    PRIOR.SALES.DATE=df$PRIOR.SALES.DATE,
    PRIOR.SALES.AMOUNT=df$PRIOR.SALES.AMOUNT,
    PRIOR.MULTI.APN.FLAG.CODE=df$PRIOR.MULTI.APN.FLAG.CODE,
    PRIOR.MULTI.APN.COUNT=df$PRIOR.MULTI.APN.COUNT,
    PRI.CAT.CODE=df$PRI.CAT.CODE,
    RESALE.NEW.CONSTRUCTION.CODE=df$RESALE.NEW.CONSTRUCTION.CODE,
    deed.file.number=rep(num, nrow(df)),
    deed.record.number=1:nrow(df))


  # keep only arms-length deeds and deeds with numeric apns
  arms.length <- r$PRI.CAT.CODE == "A"  # arms-length deeds
  r <- r[arms.length, ]
  
  list(df=r, num.dropped=nrow(r) - sum(arms.length))
  }
```

## Read the deed files

Concatenate all the deeds files into one data frame.

```{r}
ReadAll <- function() {
  # Value: list
  # $df : data frame containing only arms-length deeds and certain features
  # $num.dropped : number of non arms-length deeds found and dropped
  Iter <- function(file.number, df, num.dropped) {
    # accumulate info in file.number
    if (file.number == 9) {
      list(df=df, num.dropped=num.dropped)
    }
    res <- ReadDeedsFile(file.number)
    cat('dropped ', res$num.dropped, ' records from file ', file.number, '\n')
    cat('nrows df', nrow(df), '\n')
    cat('nrows res$df', nrow(res$df), '\n')
    Iter(file.number + 1, 
         rbind(df, res$df), 
         num.dropped + res$num.dropped)
  }
  Iter(1, NULL, 0)
}
all <- ReadAll()
cat('total number of non-arms length deeds', all$num.dropped, '\n')
str(all$df)
summary(all$df)
stop()

df.all <- rbind(ReadDeedsFile(1),
                ReadDeedsFile(2),
                ReadDeedsFile(3),
                ReadDeedsFile(4),
                ReadDeedsFile(5),
                ReadDeedsFile(6),
                ReadDeedsFile(7),
                ReadDeedsFile(8))

  
cat("number of deeds records with not at arms length", not.arms.length, "\n")
cat("number of deeds records at arms length", nrow(df.all), "\n") 
```

## Drop features that are non-informative

```{r}
df.all <- RemoveNonInformative(df.all, cat)
cat("deeds columns retained (others dropped because non informative)\n")
for (colname in colnames(df.all)) {
  cat(" ", colname, "\n")
}
```

## Remove duplicate deeds

Duplicate deeds cause problems in some downstream processes in the pipeline. So remove
any duplicates.

```{r}
nondups <- unique(df.all)
cat(sprintf("dropped %d deeds that were duplicates of others\n",
            nrow(df.all) - nrow(nondups)))
cat("number of unique relevant deeds", nrow(nondups), "\n")
```

## Write unique deeds to csv

```{r}
cat("writing unique arms-length deeds to", path.deeds.out, "\n")
write.csv(nondups,
          file=path.deeds.out,
          quote=FALSE)
```
